window.IB = window.IB || {}; window.IB.sd = window.IB.sd || {}; !function(){"use strict";function e(e){e%=2147483647;var t=function(){return e=16807*e%2147483647,(e-1)/2147483646};return t(),t(),t(),t}var t="talea";if(window.IB.sd[t])return console.error("Warning: "+t+" loaded twice."),void(window.IB.sd[t].bind&&window.IB.sd[t].bind());var s=function(e){for(var t={},s=e.substring(1).split("&"),i=0;i<s.length;i++){var n=s[i].split("=");n[0]&&(t[n[0]]=n[1]||!0)}return t},i=function(){if(!document.querySelector)return{};var e=null,t=null,i=document.querySelector("[data-userid]");i&&(e=i.getAttribute("data-userid"));var n=document.getElementsByClassName("usertext");n&&n.length&&(t=n[0].innerText),e||(e=1,t="Usuari convidat");var r=null!=document.querySelector('.usermenu li a[href*="switchrole"]')?1:0;r||(r=null!=document.querySelector(".teacherdash.nav-item.nav-link")?1:0);var a=null,o=null,l=document.querySelector(".homelink > a");if(l){o=l.innerText;var d="?"+(l.href.split("?")[1]||"");a=s(d).id}else console.error("Cannot find footer in document");var c=(location.href.split("?")[0]||"").replace("/mod/book/view.php","");return{userId:e,userFullname:t,isTeacher:r,site:c,courseName:o,courseId:a}},n=function(e,t){if(!t||!document.getElementById(t)){var s=document.createElement("style");s.type="text/css",s.innerHTML=e,t&&(s.id=t),document.getElementsByTagName("head")[0].appendChild(s)}};n("@media print and (color) {.pw-tasca-solucio, .pw-tasca-nprt {display:none!important;}}","pw-microtasca");var r=function(e){var t=this;if(this.pi=i(),this.pi.isTeacher&&e.dataset.debug){for(var s=JSON.parse(e.dataset.debug),n=Object.keys(s),r=0,o=n.length;o>r;r++){var l=n[r];this.pi[l]=s[l]}console.log(this.pi);var d=document.createElement("div");d.innerHTML="<p>DEBUG INFO::<br>  "+JSON.stringify(this.pi)+"</p>",e.append(d)}this.pi.userId>0&&$.ajax({method:"POST",url:"https://piworld.es/iedibapi/p1/users/create",data:t.pi,dataType:"json"}).done(function(e){console.log(e)}),this.container=e;var c=this.container.dataset;this.seed=parseInt(c.seed||"1");var u=JSON.parse(c.different||"[]"),h=e.querySelectorAll("div.iedib-tabmenu:not(.talea-skip)");this.smartMenus=[];for(var r=0,o=h.length;o>r;r++)this.smartMenus.push(new a(h[r],this.pi,u));var p=document.createElement("p");p.id="talea-name",p.style["font-weight"]="bold",p.innerText="Tasca de "+(this.pi.userFullname||"???"),this.container.prepend(p),this.pi.isTeacher?this.setupTeacher():this.showUser(this.pi.userId)};r.prototype.showUser=function(t){t=parseInt(t||"0"),this.pi.isTeacher&&this.mapStudents&&this.mapStudents[t]&&(document.querySelector("#talea-name").innerText="Tasca de "+this.mapStudents[t]);for(var s=e(t*this.seed),i=0,n=this.smartMenus.length;n>i;i++)this.smartMenus[i].showUser(s,t)},r.prototype.clear=function(){this.pi.isTeacher&&$("#talea-name").text("Sense filtre");for(var e=0,t=this.smartMenus.length;t>e;e++)this.smartMenus[e].clear()},r.prototype.dispose=function(){this.clear()},r.prototype.setupTeacher=function(){var e=this,t=document.createElement("div");t.id="talea-controls",this.container.prepend(t);var s='<input type="text" class="form-control" placeholder="Nom o id de l\'estudiant..." list="list_controls_userid" id="controls_userid"><br>';s+='<datalist id="list_controls_userid">',s+='<option value="-1">Sense filtre</option>',s+="</datalist>",t.innerHTML=s;var i=t.querySelector("#controls_userid");i&&i.addEventListener("change",function(t){var s=parseInt(i.value||"0");0>s?e.clear():e.showUser(s,i.innerText)})};var a=function(e,t,s){this.pi=t,this.forceDifferent=s||[],e.style.border="none",this.theTabMenu=e.querySelector("ul.nav.nav-tabs"),this.theLinks=this.theTabMenu.querySelector("li"),this.theContent=e.querySelector("div.tab-content"),this.theContentOpts=this.theContent.querySelectorAll("div.iedib-tabpane"),this.numOpts=this.theContentOpts?this.theContentOpts.length:0};a.prototype.showUser=function(e,t){this.pi.isTeacher?this.theTabMenu.style.display="none":this.theTabMenu.remove();for(var s=-1,i=0,n=this.forceDifferent.length;n>i;i++){for(var r=this.forceDifferent[i],a=0,o=r.length;o>a;a++)if(r[a]==t){console.log("Restriction on ",r),s=a;break}if(s>=0)break}var l=0;l=s>=0?s%this.numOpts:Math.floor(e()*this.numOpts);for(var i=0,n=this.theContentOpts.length;n>i;i++){var d=this.theContentOpts[i],c=this.theLinks[i];i==l?(d.classList.add("active"),d.style.display="",c&&c.classList.add("active")):(d.classList.remove("active"),this.pi.isTeacher?d.style.display="none":d.remove(),c&&c.classList.remove("active"))}},a.prototype.clear=function(){this.theTabMenu.style.display="";for(var e=0,t=0,s=this.theContentOpts.length;s>t;t++){var i=this.theContentOpts[t],n=this.theLinks[t];i.style.display="",t==e?(i.classList.add("active"),n&&(n.style.display="",n.classList.add("active"))):(i.classList.remove("active"),n&&(n.style.display="",n.classList.remove("active")))}},a.prototype.dispose=function(){this.clear()};var o={author:"Josep Mulet",version:"1.0",inst:{}};window.IB.sd[t]=o;var l=function(){for(var e=document.querySelectorAll('div[role="snptd_'+t+'"]'),s=0,i=e.length;i>s;s++){var n=e[s];if(!n.dataset.active){n.dataset.active="1";var a=new r(n),o=n.getAttribute("id");o||(o="dynamic_"+Math.random().toString(32).substring(2),n.id=o),a.pi.isTeacher&&(window.IB.sd[t].inst[o]=a,$.ajax({method:"POST",url:"https://piworld.es/iedibapi/p1/users/list",data:a.pi,dataType:"json"}).done(function(e){var t=$("#list_controls_userid");a.mapStudents={},a.mapStudents[-1]="Sense filtre";for(var s=0,i=e.length;i>s;s++){var n=e[s],r=parseInt(n.userid||"0");a.mapStudents[r]=n.userfullname,t.append($('<option value="'+n.userid+'">'+n.userfullname+"</option>"))}}))}}};o.bind=l,o.unbind=function(){for(var e=Object.values(o.inst),t=0,s=e.length;s>t;t++)e[t].dispose();o.inst={}},$(function(){l()})}();