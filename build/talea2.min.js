window.IB = window.IB || {}; window.IB.sd = window.IB.sd || {}; !function(){"use strict";function e(e){e%=2147483647;var t=function(){return e=16807*e%2147483647,(e-1)/2147483646};return t(),t(),t(),t}var t="talea";if(window.IB.sd[t])return console.error("Warning: "+t+" loaded twice."),void(window.IB.sd[t].bind&&window.IB.sd[t].bind());var i=function(e){for(var t={},i=e.substring(1).split("&"),n=0;n<i.length;n++){var s=i[n].split("=");s[0]&&(t[s[0]]=s[1]||!0)}return t},n=function(){if(!document.querySelector)return{};var e=null,t=null,n=document.querySelector("[data-userid]");n&&(e=n.getAttribute("data-userid"));var s=document.getElementsByClassName("usertext");if(s&&s.length)t=s[0].innerText;else{var r=document.querySelector("div.logininfo > a");r&&(t=r.innerText)}e||(e=1,t="Usuari convidat");var o=null!=document.querySelector('.usermenu li a[href*="switchrole"]')?1:0;o||(o=null!=document.querySelector(".teacherdash.nav-item.nav-link")?1:0),o||(o=null!=document.querySelector("form.editmode-switch-form")?1:0);var a=null,d=null,l=document.querySelector(".homelink > a");if(l){d=l.innerText;var u="?"+(l.href.split("?")[1]||"");a=i(u).id}else{window.M&&M.cfg&&(a=M.cfg.courseId);var c=document.querySelector("#page-navbar ol > li:first-child > a");c?d=c.innerText:console.error("Cannot find footer in document")}var h=(location.href.split("?")[0]||"").replace("/mod/book/view.php","");return{userId:e,userFullname:t,isTeacher:o,site:h,courseName:d,courseId:a}},s=function(e,t){if(!t||!document.getElementById(t)){var i=document.createElement("style");i.type="text/css",i.innerHTML=e,t&&(i.id=t),document.getElementsByTagName("head")[0].appendChild(i)}};s("@media print and (color) {.pw-tasca-solucio, .pw-tasca-nprt {display:none!important;}}","pw-microtasca");var r=function(e){var t=this;if(this.pi=n(),this.pi.isTeacher&&e.dataset.debug){for(var i=JSON.parse(e.dataset.debug),s=Object.keys(i),r=0,a=s.length;a>r;r++){var d=s[r];this.pi[d]=i[d]}console.log(this.pi);var l=document.createElement("div");l.innerHTML="<p>DEBUG INFO::<br>  "+JSON.stringify(this.pi)+"</p>",e.append(l)}this.pi.userId>0&&$.ajax({method:"POST",url:"https://piworld.es/iedibapi/p1/users/create",data:t.pi,dataType:"json"}).done(function(e){console.log(e)}),this.container=e;var u=this.container.dataset;this.seed=parseInt(u.seed||"1")||1;var c=JSON.parse(u.different||"[]");this.workingMode=u.mode||"urandom";var h=e.querySelectorAll("div.iedib-tabmenu:not(.talea-skip)");this.smartMenus=[];for(var r=0,a=h.length;a>r;r++)this.smartMenus.push(new o(h[r],this.pi,c,this.workingMode,this.seed));var p=document.createElement("p");p.id="talea-name",p.style["font-weight"]="bold",p.innerText="Tasca de "+(this.pi.userFullname||"???"),this.container.prepend(p),this.pi.isTeacher?this.setupTeacher():this.showUser(this.pi.userId)};r.prototype.showUser=function(t){t=parseInt(t||"0"),this.pi.isTeacher&&this.mapStudents&&this.mapStudents[t]&&(document.querySelector("#talea-name").innerText="Tasca de "+this.mapStudents[t]);var i=null;"urandom"===this.workingMode?i=e(t*this.seed):"lrandom"===this.workingMode&&(i=e(this.seed));for(var n=0,s=this.smartMenus.length;s>n;n++)this.smartMenus[n].showUser(i,t)},r.prototype.clear=function(){this.pi.isTeacher&&$("#talea-name").text("Sense filtre");for(var e=0,t=this.smartMenus.length;t>e;e++)this.smartMenus[e].clear()},r.prototype.dispose=function(){this.clear()},r.prototype.setupTeacher=function(){var e=this,t=document.createElement("div");t.id="talea-controls",this.container.prepend(t);var i='<input type="text" class="form-control" placeholder="Nom o id de l\'estudiant..." list="list_controls_userid" id="controls_userid"><br>';i+='<datalist id="list_controls_userid">',i+='<option value="-1">Sense filtre</option>',i+="</datalist>",t.innerHTML=i;var n=t.querySelector("#controls_userid");n&&n.addEventListener("change",function(t){var i=parseInt(n.value||"0");0>i?e.clear():e.showUser(i,n.innerText)})};var o=function(e,t,i,n,s){this.pi=t,this.forceDifferent=i||[],this.workingMode=n||"urandom",this.seed=s||1,e.style.border="none",this.theTabMenu=e.querySelector("ul.nav.nav-tabs"),this.theLinks=this.theTabMenu.querySelector("li"),this.theContentOpts=e.querySelectorAll("div.tab-content > div"),this.numOpts=this.theContentOpts.length,0===this.numOpts&&(console.error("ERROR: theContentOpts is Empty!"),this.numOpts=1)};o.prototype.showUser=function(e,t){this.pi.isTeacher?this.theTabMenu.style.display="none":this.theTabMenu.remove();for(var i=-1,n=0,s=this.forceDifferent.length;s>n;n++){for(var r=this.forceDifferent[n],o=0,a=r.length;a>o;o++)if(r[o]==t){i=o;break}if(i>=0)break}var d=0;if("urandom"===this.workingMode||"lrandom"===this.workingMode)d=i>=0?i%this.numOpts:Math.floor(e()*this.numOpts);else if(this.workingMode.startsWith("fixed")){if(this.workingMode.indexOf(":")>0){var l=this.workingMode.split(":")[1].trim();l&&(d=parseInt(l)||0)}}else console.error("ERROR: Unknown working mode ",this.workingMode,", choosing first element");for(var n=0,s=this.theContentOpts.length;s>n;n++){var u=this.theContentOpts[n],c=this.theLinks[n];n==d?(u.classList.add("active"),u.style.display="",c&&c.classList.add("active")):(u.classList.remove("active"),this.pi.isTeacher?u.style.display="none":u.remove(),c&&c.classList.remove("active"))}},o.prototype.clear=function(){this.theTabMenu.style.display="";for(var e=0,t=0,i=this.theContentOpts.length;i>t;t++){var n=this.theContentOpts[t],s=this.theLinks[t];n.style.display="",t==e?(n.classList.add("active"),s&&(s.style.display="",s.classList.add("active"))):(n.classList.remove("active"),s&&(s.style.display="",s.classList.remove("active")))}},o.prototype.dispose=function(){this.clear()};var a={author:"Josep Mulet",version:"2.0",inst:{}};window.IB.sd[t]=a;var d=function(){for(var e=document.querySelectorAll('div[role="snptd_'+t+'"]'),i=0,n=e.length;n>i;i++){var s=e[i];if(!s.dataset.active){s.dataset.active="1";var o=new r(s),a=s.getAttribute("id");a||(a="dynamic_"+Math.random().toString(32).substring(2),s.id=a),o.pi.isTeacher&&(window.IB.sd[t].inst[a]=o,$.ajax({method:"POST",url:"https://piworld.es/iedibapi/p1/users/list",data:o.pi,dataType:"json"}).done(function(e){var t=$("#list_controls_userid");o.mapStudents={},o.mapStudents[-1]="Sense filtre";for(var i=0,n=e.length;n>i;i++){var s=e[i],r=parseInt(s.userid||"0");o.mapStudents[r]=s.userfullname,t.append($('<option value="'+s.userid+'">'+s.userfullname+"</option>"))}}))}}};a.bind=d,a.unbind=function(){for(var e=Object.values(a.inst),t=0,i=e.length;i>t;t++)e[t].dispose();a.inst={}};var l=function(e,t){return t=t||0,window.require&&"function"==typeof window.require?void e():t>15?void console.error("Talea:: Cannot find requirejs"):void window.setTimeout(function(){l(e,t+1)},500)};l(function(){require(["jquery"],function(e){e(function(){d()})})})}();